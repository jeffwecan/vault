---

# This playbook should configure a vault + consul image for use with packet, etc.

- name: Vault Consul AMI
  hosts: all
  connection: local
  become_user: root
  become: yes
  become_method: sudo
  strategy: debug  # just something to think about...

  vars:
    - cache_valid_time: 600
    - tmp_certs_path: "/etc/consul.d/ssl/"
    - consul_ssl_cert: "{{ lookup('file', '{{ tmp_certs_path }}/{{ consul_ssl_cert_filename }}') }}"
    - consul_ssl_ca_cert: "{{ lookup('file', '{{ tmp_certs_path }}/{{ consul_ssl_ca_cert_filename }}') }}"
    - consul_ssl_key: "{{ lookup('file', '{{ tmp_certs_path }}/{{ consul_ssl_key_filename }}') }}"
    - register_with_zabbix: false
    - datacenter: 'need_a_value_to_look_up_here'


  roles:
    - { role: ami-cleanup, tags: role_ami_cleanup }
    - { role: common-packages, tags: role_common_packages }
    - { role: consul, tags: role_consul }
    - { role: td-agent, tags: role_td_agent }
    - { role: ufw-firewall, tags: role_ufw_firewall }
    - { role: security, tags: role_security }
    - { role: zabbix-agent, tags: role_zabbix_agent, when: register_with_zabbix }

