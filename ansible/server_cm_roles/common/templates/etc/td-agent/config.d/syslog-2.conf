<source>
  @type syslog
  port {{ fluentd_syslog_port }}
  bind 127.0.0.1
  tag system
</source>

<filter system.**>
  @type record_transformer
  <record>
    facility ${tag_parts[-2]}
    priority ${tag_parts[-1]}
    datacenter_group {{ datacenter_group }}
  </record>
</filter>

# Log Forwarding
<match system.**>
  @type copy
  deep_copy true
  <store>
    @type rewrite_tag_filter
    rewriterule1 ident wp-cli-commands  wpcli
  </store>
  <store>
    @type bigquery
    method          insert
    flush_interval  {{ fluentd_bq_flush_interval }}

    buffer_type file
    buffer_path /var/log/td-agent/buffer/syslog_buffer
    buffer_chunk_limit 1M
    buffer_queue_limit 10000
    buffer_chunk_records_limit    200

    auth_method json_key
    json_key    /etc/td-agent/key.json

    project   {{ fluentd_project }}
    dataset   {{ fluentd_syslog_dataset }}

    time_slice_format %Y%m%d
    tables syslogs_%{time_slice}

    auto_create_table true
    time_format   %s
    time_field    time

    field_integer   time,pri
    field_string    facility,priority,pid,host,ident,message,aggr_cluster,datacenter_group
  </store>
</match>
