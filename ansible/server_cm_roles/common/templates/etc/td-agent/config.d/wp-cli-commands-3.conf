<filter wpcli.**>
  @type parser
  format json
  key_name message
  reserve_data true
</filter>

<filter wpcli.**>
  @type record_transformer
  remove_keys pid,msgid,extradata,message,ident,pri,facility,priority,pid,aggr_cluster
</filter>

<match wpcli.**>
  @type           bigquery
  method          insert

  auth_method json_key
  json_key    /etc/td-agent/key.json

  <buffer time>
    flush_interval      {{ fluentd_bq_flush_interval }}
    queue_limit_length  10240   # 1MB * 10240 -> 10GB!
    chunk_limit_size    1M
    chunk_records_limit 200     # rate limit is 500

    timekey             1d
  </buffer>

  project   {{ fluentd_project }}
  dataset   {{ fluentd_wpcli_dataset }}

  auto_create_table         true
  table                     commands
  template_suffix           _%Y%m%d

  <inject>
    time_key    time
    time_type   string
    time_format %s
  </inject>
</match>
