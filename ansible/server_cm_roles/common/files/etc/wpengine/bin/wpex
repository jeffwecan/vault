#!/bin/bash
# Author: Mike Van Winkle
# Date: 05-15-2014
# Purpose: Easy management of WPEnginx options
# Change Log:
# - v 1..0 Initial Release
LOGGING=1

function wpenginx() { 
	command=${1:-'usage'}
	case $command in
		disable-bucket)
			bucket=${2?:"Please enter the bucket you would like to disable"}
			if [ ! -f /etc/wpengine/nginx/buckets-enabled/$bucket.conf ] ; then echo "No bucket '$bucket' enabled by this name"; exit 1; fi
			rm /etc/wpengine/nginx/buckets-enabled/$bucket.conf 
			check=$( sudo nginx -t 2>&1 | echo $? )
			if [[ 0 != $check ]]; then 
				echo "Couldn't reload nginx. Process FAILED";
				exit 1
			fi
			service nginx reload 
			echo "Disabled bucket '$bucket'"
			exit
		;;
		enable-bucket)
			bucket=${2?:"Please enter the bucket you would like to disable"}
			if [ -f /etc/wpengine/nginx/buckets-enabled/$bucket.conf ] ; then echo "Bucket '$bucket' already enabled"; exit 1; fi
			if [ ! -f /etc/wpengine/nginx/buckets-available/$bucket.conf ] ; then echo "Could not find bucket '$bucket' to enable"; exit 1; fi
			ln -s /etc/wpengine/nginx/buckets-available/$bucket.conf /etc/wpengine/nginx/buckets-enabled/$bucket.conf
			check=$( sudo nginx -t 2>&1 | echo $? )
			if [[ 0 != $check ]]; then 
				echo "Couldn't reload nginx. Process FAILED";
				exit 1
			fi
			service nginx reload 
			echo "Enabled bucket '$bucket'" 
			exit
		;;
		show-queues)
			php /etc/wpengine/bin/queues.php --account=all
			exit
		;;
		*) 
cat <<wpexusage
	This script is for interacting with wpengine real time

	USAGE: 	wpex [command] <options>

	AVAILABLE COMMANDS: 
		disable-bucket <bucket>	Disables a queueing bucket for a particular handle
			i.e. wpex disable-bucket 'adminajax'
		enable-bucket <bucket>	Enables a queueing bucket for handle
			i.e. wpex enable-bucket  'adminajax'
wpexusage
		;;
	esac
}

OUTPUT=$( wpenginx "$@" )
echo -e "$OUTPUT"  
if [ "$LOGGING" -eq 1 ]; then
	logger "[WPEX] $OUTPUT" 
fi
