#! /usr/bin/python
import json,sys,string,urllib2,socket

if len(sys.argv) < 4:
    sys.exit('Usage: %s dot.separated.site.key statskey stattype' % sys.argv[0])

hostname = socket.gethostname()

host = '127.0.0.1'
port = 8125

url = 'http://localhost/proxyprint' 
response = urllib2.urlopen(url)
j=json.load(response)

jsonkey = sys.argv[1]
statskey = sys.argv[2];
countertype = sys.argv[3];

keys = string.split(jsonkey, '.')
total = 0
for bucket in j['sites']:
    v = bucket
    for key in keys:
        if key in v:
            v=v[key]
        else:
            break;
    else:  
        total += v
        message = "%s.%s:%d|%s" % (statskey, bucket['bucket_name'], v, countertype)
        sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        sock.sendto(message, (host, port))
	print message

message = "%s.total:%d|%s" % (statskey, total, countertype)
print message
sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.sendto(message, (host, port))
