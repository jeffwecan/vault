<source>
  @type syslog
  port {{ fluentd_syslog_port }}
  bind 127.0.0.1
  tag system
</source>

<filter syslog.**>
  @type record_transformer
  <record>
    facility ${tag_parts[-2]}
    priority ${tag_parts[-1]}
    datacenter_group {{ my.cluster.datacenter }}
  </record>
</filter>

# Log Forwarding
<match system.**>
  @type           bigquery
  method          insert

  auth_method json_key
  json_key    /etc/td-agent/key.json

  <buffer time>
    @type               file
    path                /var/log/td-agent/buffer/syslog_buffer
    flush_interval      {{ fluentd_bq_flush_interval }}
    queue_limit_length  10000
    chunk_limit_size    1M
    chunk_records_limit 200

    timekey             1d
  </buffer>

  project   {{ fluentd_project }}
  dataset   {{ fluentd_syslog_dataset }}

  auto_create_table         true
  table                     syslogs
  template_suffix           _%Y%m%d

  <inject>
    time_key    time
    time_type   string
    time_format %s
  </inject>

  field_integer   time,pri
  field_string    facility,priority,pid,host,ident,message,aggr_cluster,datacenter_group
</match>
