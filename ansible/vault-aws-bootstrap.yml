---

- name: Vault AWS Bootstrap
  hosts: all
  connection: local
  become_user: root
  become: yes
  become_method: sudo

  vars:
    - vault_config_path: /etc/vault.d
    - tmp_certs_path: "{{ vault_config_path }}/ssl/"
    - vault_ssl_cert: "{{ lookup('file', '{{ vault_ssl_crt_path }}') }}"
    - vault_ssl_ca_cert: "{{ lookup('file', '{{ vault_ssl_ca_crt_path }}') }}"
    - vault_ssl_key: "{{ lookup('file', '{{ vault_ssl_key_path }}') }}"
    - default_secret_threshold: 3
    - consul_run_as_server: false
    - vault_url: https://127.0.0.1:8200
    - consul_leader_election_session: vault
    - consul_leader_election_key: service/vault/leader
    - vault_unseal_pgp_keys:
      - { keybase: jeffreyhogan, email: jeffrey.hogan@wpengine.com }

  environment:
    VAULT_ADDR: "{{ vault_url }}"
    VAULT_CLIENT_CERT: /etc/vault.d/ssl/vault.crt.pem
    VAULT_CLIENT_KEY: /etc/vault.d/ssl/vault.key.pem
    VAULT_CACERT: /usr/share/ca-certificates/wpengine/vault_ca.crt

  pre_tasks:
    - name: Display all variables/facts known when -v option is set
      debug:
        var: hostvars[inventory_hostname]
        verbosity: 1
      tags:
        - bootstrap

  roles:
    - { role: ami-cleanup, tags: role_ami_cleanup }
    - { role: common-packages, tags: role_common_packages }
    - { role: vault, tags: role_vault }
    - { role: td-agent, tags: role_td_agent }
    - { role: ufw-firewall, tags: role_ufw_firewall }
    - { role: security, tags: role_security }
    - { role: zabbix-agent, tags: role_zabbix_agent, when: register_with_zabbix }

